Notes on getting portalup and running from fresh portalinstall

sudo yum update -y

# Disable SELinux:
sudo sed -i -e "s/SELINUX=enforcing/SELINUX=disabled/g" \
     /etc/selinux/config
sudo reboot

# If no DNS name is set, set it in /etc/hosts

# If we've allocated from GRAM, need to open up ports 80, 443, 8443, 8444
# On the GRAM machine:
# WIth slice and project name changed appropriately
source /etc/novarc 
nova --os-username=admin-ch.geni.net:COUNT+slice+CENTOS-TEST --os-password="sliceMaster:-)" --os-tenant-name=ch.geni.net:COUNT+slice+CENTOS-TEST secgroup-add-rule ch.geni.net:COUNT+slice+CENTOS-TEST_secgrp tcp 80 80 0.0.0.0/0
nova --os-username=admin-ch.geni.net:COUNT+slice+CENTOS-TEST --os-password="sliceMaster:-)" --os-tenant-name=ch.geni.net:COUNT+slice+CENTOS-TEST secgroup-add-rule ch.geni.net:COUNT+slice+CENTOS-TEST_secgrp tcp 443 443 0.0.0.0/0
nova --os-username=admin-ch.geni.net:COUNT+slice+CENTOS-TEST --os-password="sliceMaster:-)" --os-tenant-name=ch.geni.net:COUNT+slice+CENTOS-TEST secgroup-add-rule ch.geni.net:COUNT+slice+CENTOS-TEST_secgrp tcp 8443 8444 0.0.0.0/0

------- No need to do any of this with apt resources -----

# 0. Update yum

sudo yum update -y

# 1. Install dependencies

# sudo yum install -y epel-release  # Don't install this. It ruins shibboleth install

# Set up repo for shibboleth
wget http://download.opensuse.org/repositories/security://shibboleth/CentOS_7/security:shibboleth.repo
sudo cp security\:shibboleth.repo /etc/yum.repos.d/

sudo yum install -y automake autoconf
sudo yum install -y emacs-nox git texinfo
sudo yum install -y python-sqlalchemy python-psycopg2 postgresql
sudo yum install -y httpd mod_ssl
sudo yum install -y shibboleth
sudo yum install -y php php-pear php-pgsql
sudo yum install -y php-xmlrpc

sudo pear install mdb2 MDB2_Driver_pgsql

# 2. Install geni-tools [Should be dependency]
git clone https://github.com/GENI-NSF/geni-tools.git


# 3. Install PORTAL and SHIB SW [This should be done from an RPM...]
# <*** From development machine ***>
export PORTAL_HOST=aptvm072-1.apt.emulab.net
cd ~/geni-portal
/usr/bin/rsync --delete --delete-excluded -aztv --exclude .git --exclude '*~' --exclude '#*#' --exclude '.#*' ../geni-portal $PORTAL_HOST:
cd ~/shib
/usr/bin/rsync --delete --delete-excluded -aztv --exclude .git --exclude '*~' --exclude '#*#' --exclude '.#*' ../shib $PORTAL_HOST:


# 3b. Prep shib. No longer need prep-shib-centos.sh
ln -s ~/shib /tmp

# 3c. Install Embedded Discovery Service
cd /tmp
wget https://github.com/GENI-NSF/geni-eds/releases/download/v1.1.0-geni.3/shibboleth-embedded-ds-1.1.0-geni.3.tar.gz
tar xvfz shibboleth-embedded-ds-1.1.0-geni.3.tar.gz
cd shibboleth-embedded-ds-1.1.0-geni.3
sudo cp *.css *.js *.html *.gif *.png /usr/share/geni-ch/www/eds

# 4. Set up Variables
cd ~/geni-portal/templates
# Edit parameters.json [Especially note portal_host, ch_host and db_host]
sudo ./geni-install-templates

# 5. Install and run Shib SP
sudo /tmp/install-sp-centos.sh

# 6. Set up SP with IDP
# <*** From Development machine *** > 

export IDP_HOST=cetaganda.gpolab.bbn.com
wget https://$PORTAL_HOST/Shibboleth.sso/Metadata --no-check-certificate
scp Metadata $IDP_HOST:/tmp/$PORTAL_HOST-metadata.xml

# <*** From $IDP_HOST ***>

If adding a new server add an entry like this to 
/opt/shibboleth-idp/conf/relying-party.xml:

  <metadata:MetadataProvider xsi:type="FilesystemMetadataProvider"
    xmlns="urn:mace:shibboleth:2.0:metadata"
    id="$PORTAL_HOST-metadata"
    metadataFile="/opt/shibboleth-idp/metadata/$PORTAL_HOST-metadata.xml"/>

sudo cp /tmp/$PORTAL_HOST-metadata.xml /opt/shibboleth-idp/metadata
sudo service tomcat6 restart

# Install GENI Portal SW
ln -s ~/geni-portal ~/proto-ch
cd ~/geni-portal/bin
./do-make-install.sh

# Install GENI PORTAL tables
cd ~/geni-portal/templates
DB_HOST=`./geni-install-templates --print_parameter db_host`
DB_USER=`./geni-install-templates --print_parameter db_user`
DB_DATABASE=`./geni-install-templates --print_parameter db_name`
DB_PASSWORD=`./geni-install-templates --print_parameter db_pass`
PSQL="psql -U $DB_USER -h $DB_HOST $DB_DATABASE"
echo "$DB_HOST:*:$DB_DATABASE:$DB_USER:$DB_PASSWORD"  > ~/.pgpass
chmod 0600 ~/.pgpass

PORTAL_DIR=/usr/share/geni-ch/portal
$PSQL -f $PORTAL_DIR/db/postgresql/schema.sql  # Note: This gives an error on defining last_seen and then bails. Update fixes it.
for upd in $PORTAL_DIR/db/postgresql/update-*.sql
do
   $PSQL -f $upd
done


# Note: We need to install in /usr/share/geni-ch/www, not /var/www which is what do-make-install does.

# We need to install the portal cert/key from the CH machine in /usr/share/geni-ch/portal



# Our problem now is that the APT VM can't get to our CH. Not routable. Need to
# use a CH that you can get to from the APT VM.


