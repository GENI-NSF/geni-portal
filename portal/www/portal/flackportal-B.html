", "flashContent",
              "100%", "100%",
              swfVersionStr, xiSwfUrlStr,
              flashvars, params, attributes);
          // JavaScript enabled so display the flashContent div in case it is not replaced with a swf object.
          swfobject.createCSS("#flashContent", "display:block;text-align:left;");

      //]]>
      </script>


      <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
      <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
      <script type="text/javascript" src="forge/debug.js"></script>
      <script type="text/javascript" src="forge/util.js"></script>
      <script type="text/javascript" src="forge/log.js"></script>
      <script type="text/javascript" src="forge/socket.js"></script>
      <script type="text/javascript" src="forge/md5.js"></script>
      <script type="text/javascript" src="forge/sha1.js"></script>
      <script type="text/javascript" src="forge/hmac.js"></script>
      <script type="text/javascript" src="forge/aes.js"></script>
      <script type="text/javascript" src="forge/asn1.js"></script>
      <script type="text/javascript" src="forge/jsbn.js"></script>
      <script type="text/javascript" src="forge/jsbn2.js"></script>
      <script type="text/javascript" src="forge/prng.js"></script>
      <script type="text/javascript" src="forge/random.js"></script>
      <script type="text/javascript" src="forge/pki.js"></script>
      <script type="text/javascript" src="forge/tls.js"></script>
      <script type="text/javascript" src="forge/http.js"></script>

      <script type="text/javascript">
      //<![CDATA[
  // logging category
  var cat = 'forge.tests.tls';

  swfobject.embedSWF(
     'forge/SocketPool.swf', 'socketPool', '0', '0', '9.0.0',
     false, {}, {allowscriptaccess: 'always'}, {});

  function getSWF()
  {
    if (navigator.appName.indexOf("Microsoft") != -1)
    {
      return window[flash_id];
    }
    else
    {
      return document[flash_id];
    }
  }

  var sp;

  function init(new_flash_id)
  {
    try {
    flash_id = new_flash_id;
    sp = net.createSocketPool({
      flashId: 'socketPool',
      policyPort: 843,
      msie: false
    });
    } catch(ex) {
       forge.log.error(cat, ex);
    }
  }

  // local aliases
  var net = window.forge.net;
  var tls = window.forge.tls;
  var http = window.forge.http;
  var util = window.forge.util;

  var clients = new Object();

  function make_request(instance, host, path, sendData)
  {
    forge.log.info(cat, "MAKE_REQUEST : " + instance);
    forge.log.info(cat, "MAKE_REQUEST : " + host);
    forge.log.info(cat, "MAKE_REQUEST : " + path);
    forge.log.info(cat, "MAKE_REQUEST : " + sendData);
    try {
    var newClient = client_init(host);
    if (clients[instance] == null)
    {
      forge.log.info(cat, "BEFORE client_send");
      clients[instance] = newClient;
      client_send(newClient, path, sendData, instance);
      forge.log.info(cat, "AFTER client_send");
    }
    } catch(ex) {
       forge.log.error(cat, ex);
    }
  }

  function cancel_request(instance)
  {
    try {
    var client = clients[instance];
    if (client != null)
    {
      client_cleanup(client);
      delete client[instance];
      if (client[instance] != null)
      {
        forge.log.debug(cat, "instance not really deleted", "");
      }
    }
    } catch(ex) {
       forge.log.error(cat, ex);
    }
    return false;
  }

  function client_init(host)
  {
    var result = null;
    forge.log.info("In client_init : " + host);
    forge.log.info("In client_init : " + sp);
    try
    {
       var arg = {
          url: host,
          socketPool: sp,
          connections: 1,
          // optional cipher suites in order of preference
          caCerts : serverCerts,
          cipherSuites: [
             tls.CipherSuites.TLS_RSA_WITH_AES_128_CBC_SHA,
             tls.CipherSuites.TLS_RSA_WITH_AES_256_CBC_SHA],
          verify: function(c, verified, depth, certs)
          {
/*
             forge.log.debug(cat,
                'TLS certificate ' + depth + ' subject: ' + certs[depth].subject.getField('CN').value + " issuer: " + certs[depth].issuer.getField('CN').value, verified);
             // Note: change to always true to test verifying without cert
             //return verified;
             // FIXME: temporarily accept any cert to allow hitting any bpe
             if(verified !== true)
             {
                forge.log.warning(cat,
                   'Certificate NOT verified. Ignored for test.');
             }
             return true;
*/
             return verified;
          },
          primeTlsSockets: false
       };
       forge.log.info("Before call to http.createClient " + arg); 
       if (clientCert != "")
       {
          forge.log.info("clientCert is not null " + clientCert);
          arg.getCertificate = function(c, request) { return clientCert; };
          arg.getPrivateKey = function(c, cert) { return clientKey; };
       }
       result = http.createClient(arg);
       forge.log.info("client_int.result = " + result);
    }
    catch(ex)
    {
       forge.log.error(cat, ex);
    }

    return result;
  }

  function client_cleanup(client)
  {
    client.destroy();
  }

  function client_send(client, path, data, instance)
  {
     forge.log.info(cat, "IN CLIENT_SEND");
     var requestArg = {
        path: path,
        method: 'GET' };
     if (data != "")
     {
       requestArg.method = 'POST';
       requestArg.headers = [{'Content-Type': 'text/xml'}];
       requestArg.body = data;
     }
     forge.log.info(cat, "before createRequest " + requestArg);
     var request = http.createRequest(requestArg);
     forge.log.info(cat, "after createRequest ");
     client.send({
        request: request,
        connected: function(e)
        {
             forge.log.info(cat, 'connected', e);
        },
        headerReady: function(e)
        {
             forge.log.info(cat, 'header ready', e);
        },
        bodyReady: function(e)
        {
           forge.log.info(cat, 'body ready called', e);
           var response = e.response.body;
           e.socket.close();
           getSWF().flash_onbody(instance, response);
        },
        error: function(e)
        {
           var response = e.type + ": " + e.message;
           if (e.cause != null)
           {
//             response += ": " + String(e.cause);
           }
           e.socket.close();
           getSWF().flash_onerror(instance, response);
        }
     });
    forge.log.info(cat, "After client.send");
     return false;
  }
   </script>
   </head>
   <body>

      <!-- SWFObject's dynamic embed method replaces this alternative HTML content with Flash content when enough
                         JavaScript and Flash plug-in support is available. The div is initially hidden so that it doesn't show
                         when JavaScript is disabled.
                -->
        <div id="flashContent">
                <p>
                        To view this page ensure that Adobe Flash Player version
                                11.1.0 or greater is installed.
                        </p>
                        <script type="text/javascript">
                                var pageHost = ((document.location.protocol == "https:") ? "https://" : "http://");
                                document.write("<a href='http://www.adobe.com/go/getflashplayer'><img src='"
                                                                + pageHost + "www.adobe.com/images/shared/download_buttons/get_flash_player.gif' alt='Get Adobe Flash player' /></a>" );
                        </script>
      </div>

      <div id="socketPool">
         <p>Could not load the flash SocketPool.</p>
      </div>

          <noscript>
            <p>Flack requires that JavaScript be turned on~</p>
          </noscript>

   </body>
</html>
